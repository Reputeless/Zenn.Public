---
title: "MSVC STL ã®æœ€è¿‘ã®æ”¹è‰¯"
emoji: "ğŸš…"
type: "tech"
topics: ["cpp"]
published: false
---

> ã“ã®è¨˜äº‹ã¯ [C++ Advent Calendar 2022](https://qiita.com/advent-calendar/2022/cxx) 22 æ—¥ç›®ã®å‚åŠ è¨˜äº‹ã§ã™ã€‚

Microsoft Visual Studio ã® C++ é–‹ç™ºç’°å¢ƒã«å«ã¾ã‚Œã‚‹ C++ æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (MSVC STL) ã¯ã€2019 å¹´ 9 æœˆã«ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–ã•ã‚Œã€GitHub ä¸Šã§æ›´æ–°ã®æ§˜å­ã‚’è¿½è·¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

https://github.com/microsoft/STL

ãƒªãƒã‚¸ãƒˆãƒªã®æœ€æ–°ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒªãƒªãƒ¼ã‚¹ç‰ˆã® Visual Studio ã‚ˆã‚Šã‚‚æ•°ãƒ¶æœˆã»ã©å…ˆè¡Œã—ã¦ã„ã‚‹ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚æ›´æ–°ãŒåæ˜ ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ [Changelog](https://github.com/microsoft/STL/wiki/Changelog) ã§ç¢ºèªã§ãã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªã§ç¢ºèªã§ãã‚‹ã€æœ€è¿‘å®Ÿè£…ã•ã‚ŒãŸèˆˆå‘³æ·±ã„æ”¹è‰¯ã‚’ 2 ã¤ç´¹ä»‹ã—ã¾ã™ã€‚

## 1. ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é–¢æ•°ã®ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—å¯¾å¿œ

ç¯„å›²ã«å¯¾ã—ã¦æ¤œç´¢ã®æ“ä½œã‚’è¡Œã†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é–¢æ•°ã®ä¸€éƒ¨ãŒã€é©åˆ‡ãªæ¡ä»¶ã‚’æº€ãŸã™å ´åˆã«ã€ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®— (SIMD) ã‚’ç”¨ã„ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã®æœ€æ–°ã® MSVC STL ã§ã¯ã€`std::find()` ã¯å†…éƒ¨ã§æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’å‘¼ã³ã¾ã™ã€‚

https://github.com/microsoft/STL/blob/cae666016151ec3392fb7170639e0e4fcb9c548c/stl/inc/xutility#L5678-L5721

ãƒ¡ãƒ¢ãƒªéé€£ç¶šãªç¯„å›²ï¼ˆä¾‹ãˆã° `std::deque`ï¼‰ã‚„é Trivial ãªè¦ç´ å‹ (ä¾‹ãˆã° `std::string`ï¼‰ã«ã‚‚å¯¾å¿œã™ã‚‹æ±ç”¨çš„ãª `find()` ã®å®Ÿè£…ã¯ä¸‹è¨˜ã®éƒ¨åˆ†ã§ã™ã€‚

https://github.com/microsoft/STL/blob/cae666016151ec3392fb7170639e0e4fcb9c548c/stl/inc/xutility#L5714-L5720

ã—ã‹ã—ã€æ¤œç´¢ã™ã‚‹ç¯„å›²ãŒãƒ¡ãƒ¢ãƒªé€£ç¶šã§ã‚ã‚Šã€ãªãŠã‹ã¤è¦ç´ ãŒ 1 ãƒã‚¤ãƒˆã§ã‚ã‚‹å ´åˆã¯ã€å‰¯ä½œç”¨ãªã—ã§å˜ç´”ãª `memchr()` ã«ç½®ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã‚’åŠ©ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¸‹è¨˜ã®éƒ¨åˆ†ãŒã€ãã®è€ƒãˆã«åŸºã¥ã„ã¦å¾“æ¥ã¾ã§å®Ÿè£…ã•ã‚Œã¦ã„ãŸã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

https://github.com/microsoft/STL/blob/cae666016151ec3392fb7170639e0e4fcb9c548c/stl/inc/xutility#L5699-L5708

ã—ã‹ã—ã€1 ãƒã‚¤ãƒˆã®è¦ç´ ã‚’æ¤œç´¢ã™ã‚‹ã‚ˆã†ãªæ©Ÿä¼šã¯å¤šããªãã€ã“ã®æœ€é©åŒ–ãŒå½¹ã«ç«‹ã¤ã‚±ãƒ¼ã‚¹ã¯é™å®šçš„ã§ã—ãŸã€‚VS 2022 17.3 ã§ã¯ã€1, 2, 4, 8 ãƒã‚¤ãƒˆã®æ•´æ•°å‹ã€ãƒã‚¤ãƒ³ã‚¿å‹ã€`std::byte` ã‚’æ¤œç´¢ã™ã‚‹éš›ã«ã€SSE2 ã¾ãŸã¯ AVX2 å‘½ä»¤ã‚’ç”¨ã„ã‚‹å®Ÿè£…ãŒæ–°ãŸã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

https://github.com/microsoft/STL/pull/2434

è©²å½“ç®‡æ‰€ã¯æ¬¡ã®éƒ¨åˆ†ã§ã™ã€‚

https://github.com/microsoft/STL/blob/cae666016151ec3392fb7170639e0e4fcb9c548c/stl/inc/xutility#L5682-L5697

`__std_find_trivial()` ã¯æœ€çµ‚çš„ã«æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

https://github.com/microsoft/STL/blob/8ddf4da23939b5c65587ed05f783ff39b8801e0f/stl/src/vector_algorithms.cpp#L1270-L1315

`vector_algorithms.cpp` å…¨ä½“ã‚’èª­ã‚€ã¨ã€`_mm_cmpeq_epi32()` ã‚„ `_mm256_cmpeq_epi32()` ã®ã‚ˆã†ãª SSE2 / AVX2 ã®æ•´æ•°æ¯”è¼ƒå‘½ä»¤ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

#### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
`std::ranges::find()` ã«ã‚ˆã£ã¦é…åˆ— `T[8192]` ã‹ã‚‰è¦ç´ ã‚’æ¤œç´¢ã™ã‚‹å‡¦ç† 1,000,000 å›ã®æ‰€è¦æ™‚é–“ã‚’è¨ˆæ¸¬ã—ãŸ [ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯](https://github.com/microsoft/STL/pull/2434#:~:text=%F0%9F%8F%81,Perf%20benchmark) ã«ã‚ˆã‚‹ã¨ã€ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—å¯¾å¿œã«ã‚ˆã£ã¦ 2ï½9 å€ã®å®Ÿè¡Œé€Ÿåº¦å‘ä¸ŠåŠ¹æœãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

|é…åˆ— | å¾“æ¥ | SIMD å®Ÿè£… | é€Ÿåº¦å‘ä¸Š |
|:--|--|--|--|
| `std::uint8_t[8192]` | 0.123933s | 0.0566276s | 2.19 å€ |
| `std::uint16_t[8192]` | 0.911876s | 0.0979886s | 9.31 å€ |
| `std::uint32_t[8192]` | 0.917381s | 0.185901s | 4.93 å€ |
| `std::uint64_t[8192]` | 0.975016s	 | 0.357151s | 2.73 å€ |


#### ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—ã«å¯¾å¿œã—ãŸé–¢æ•°
`std::find()` ä»¥å¤–ã®é–¢æ•°ã«ã¤ã„ã¦ã‚‚ã€ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—å¯¾å¿œãŒé€²ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ä¸‹è¨˜ã«ç¾æ™‚ç‚¹ã§ã®çŠ¶æ³ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

| é–¢æ•° | å¯¾å¿œãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|--|--|
|`std::swap_ranges()` | VS 2022 ä»¥å‰ |
|`std::ranges::swap_ranges()` | VS 2022 ä»¥å‰ |
|`std::array::swap()` | VS 2022 ä»¥å‰ |
|`std::reverse()` | VS 2022 ä»¥å‰ |
|`std::ranges::reverse()` | VS 2022 ä»¥å‰ |
|`std::reverse_copy()` | VS 2022 ä»¥å‰ |
|`std::ranges::reverse_copy()` | VS 2022 ä»¥å‰ |
|`std::find()` | VS 2022 17.3 |
|`std::ranges::find()` | VS 2022 17.3 |
|`std::count()` | VS 2022 17.3 |
|`std::ranges::count()` | VS 2022 17.3 |
|`std::min_element()` | VS 2022 17.4 |
|`std::ranges::min_element()` | VS 2022 17.4 |
|`std::max_element()` | VS 2022 17.4 |
|`std::ranges::max_element()` | VS 2022 17.4 |
|`std::minmax_element()` | VS 2022 17.4 |
|`std::ranges::minmax_element()` | VS 2022 17.4 |

ãƒªãƒã‚¸ãƒˆãƒªã® Issues ã‹ã‚‰ã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã«ã¤ã„ã¦ã‚‚ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—å¯¾å¿œãŒæ¤œè¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

| é–¢æ•° | é–¢é€£ Issue |
|--|--|
|`std::search()` | [#2453](https://github.com/microsoft/STL/issues/2453) |
|`std::ranges::search()` | [#2453](https://github.com/microsoft/STL/issues/2453) |
|`std::ranges::min()` | [#2803](https://github.com/microsoft/STL/issues/2803) |
|`std::ranges::max()` | [#2803](https://github.com/microsoft/STL/issues/2803) |
|`std::ranges::minmax()` | [#2803](https://github.com/microsoft/STL/issues/2803) |
|`std::find_last()` | [#3274](https://github.com/microsoft/STL/issues/3274) |
|`std::ranges::find_last()` | [#3274](https://github.com/microsoft/STL/issues/3274) |


## 2. ä¹±æ•°ã®ä¸€æ§˜åˆ†å¸ƒã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é«˜é€ŸåŒ–

ä¹±æ•°ç”Ÿæˆå™¨ã‹ã‚‰ã€ä¸€å®šã®ç¯„å›²ã«ä¸€æ§˜åˆ†å¸ƒã™ã‚‹æ•´æ•°ã‚’å¾—ã‚‹ã¨ãã«ã¯ã€C++11 ã§å°å…¥ã•ã‚ŒãŸ `std::uniform_int_distribution` ã‚’ä½¿ã„ã¾ã™ã€‚ãã®å†…éƒ¨ã§ä½¿ãˆã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã¤ã„ã¦ã€2019 å¹´ã«æ–°ã—ã„é«˜é€Ÿãªæ–¹æ³•ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚

https://lemire.me/blog/2019/06/06/nearly-divisionless-random-integer-generation-on-various-systems/

- è«–æ–‡: https://arxiv.org/abs/1805.10941

åŸºæœ¬çš„ã«ã¯é™¤ç®—ã®å‰Šæ¸›ãŒé«˜é€ŸåŒ–ã«è²¢çŒ®ã—ã¦ã„ã¾ã™ã€‚æ¬¡ã®è¨˜äº‹ã«æ¦‚è¦ãŒã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚

https://lemire.me/blog/2019/09/28/doubling-the-speed-of-stduniform_int_distribution-in-the-gnu-c-library/

ã“ã®æ”¹è‰¯ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ã€2020 å¹´ã« [libstdc++ ã«ãƒãƒ¼ã‚¸](https://gcc.gnu.org/git/?p=gcc.git;a=blobdiff;f=libstdc%2B%2B-v3/include/bits/uniform_int_dist.h;h=ecb8574864aee10b9ea164379fffef27c7bdb0df;hp=6e1e3d5fc5fe8f7f22e62a85b35dc8bfa4743372;hb=98c37d3bacbb2f8bbbe56ed53a9547d3be01b66b;hpb=6ce2cb116af6e0965ff0dd69e7fd1925cf5dc68c) ã•ã‚Œã€[ç´„ 2 å€ã®é€Ÿåº¦å‘ä¸Š](https://lemire.me/blog/2019/09/28/doubling-the-speed-of-stduniform_int_distribution-in-the-gnu-c-library/)ãŒå ±å‘Šã•ã‚Œã¾ã—ãŸã€‚

MSVC STL ã«ãŠã„ã¦ã‚‚ã€ãã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚Šã€VS 2022 17.5 ã§ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚ä¸‹è¨˜ã® Conversation ã§ã¯ã€ãŠã‚ˆã 1ï½2 å€å‰å¾Œã®é«˜é€ŸåŒ–ã¨ã€ã¨ãã« x86 ã§ã¯ `std::mt19937`, x64 ã§ã¯ `std::mt19937_64` ã®ã‚ˆã†ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«åˆã£ãŸä¹±æ•°ç”Ÿæˆå™¨ã¨çµ„ã¿åˆã‚ã›ãŸã¨ãã«åŠ¹æœãŒé¡•è‘—ã§ã‚ã£ãŸã“ã¨ãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/microsoft/STL/pull/3012

https://github.com/microsoft/STL/blob/c31ca543af44d2a84d07c9ac73c41e9676c89517/stl/inc/random#L1747-L1794

### ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å¤‰æ›´ã«ä¼´ã†æ³¨æ„
ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å¤‰æ›´ã«ä¼´ã„ã€MSVC STL ã® `std::uniform_int_distribution` ã¯ã€éå»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã¯ç•°ãªã‚‹çµæœã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```cpp
#include <iostream>
#include <random>

int main()
{
	std::mt19937 rng;
	std::uniform_int_distribution<int> ud{ 0, 100 };

	for (int i = 0; i < 5; ++i)
	{
		std::cout << ud(rng) << '\n';
	}
}
```

VS 2022 17.4 ã¾ã§
```txt
53
20
50
22
63
```

VS 2022 17.5 ä»¥é™
```txt
82
13
91
84
12
```

C++ è¦æ ¼ã¯ `uniform_int_distribution` ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’è¦å®šã—ã¦ã„ãªã„ãŸã‚ã€ä»Šå¾Œã‚‚ã“ã®ã‚ˆã†ãªå¤‰æ›´ãŒèµ·ã“ã‚Šãˆã¾ã™ã€‚äº’æ›æ€§ãŒé‡è¦ãªå ´åˆã¯è‡ªå‰ã®å®Ÿè£…ã‚’ç”¨æ„ã™ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ï¼ˆä¾‹ãˆã° Siv3D ã§ã¯ [abseil](https://github.com/abseil/abseil-cpp) ã® `uniform_int_distribution` ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ï¼‰ã€‚


## ãŠã‚ã‚Šã«
ä»Šå›ç´¹ä»‹ã—ãŸä¾‹ã®ã‚ˆã†ã«ã€æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é–¢æ•°ã¯é«˜åº¦ãªæœ€é©åŒ–ãŒè¡Œã‚ã‚Œã¦ã„ã¦ã€è‡ªå‰ã§ãƒ«ãƒ¼ãƒ—ã‚’æ›¸ãã‚ˆã‚Šã‚‚æ•°å€é«˜é€Ÿã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ã“ã†ã—ãŸæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå®Ÿè£…ã®æ”¹è‰¯ã®æ©æµã‚’å—ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã€è‡ªèº«ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå®Ÿè£…ã®é«˜é€ŸåŒ–ã«æ³¨ç›®ã—ã¾ã—ãŸãŒã€MSVC STL ã® Changelog ãŠã‚ˆã³é–¢é€£ Issues ã¯ã€å¤‰æ›´å†…å®¹ã‚„ãã®ç›®çš„ãªã©ãŒèª­ã¿ã‚„ã™ãæ•´ç†ã•ã‚Œã¦ã„ã¦ã€C++ è¦æ ¼ã®å­¦ç¿’ã‚„ã€C++ ã«ãŠã‘ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨­è¨ˆã®è‰¯ã„å‚è€ƒè³‡æ–™ã«ãªã‚Šã¾ã™ã€‚ãœã²æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/microsoft/STL/wiki/Changelog

https://github.com/microsoft/STL/issues

